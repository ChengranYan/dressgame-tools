var __reflect=this&&this.__reflect||function(t,e,a){t.__class__=e,a?a.push(e):a=[e],t.__types__=t.__types__?a.concat(t.__types__):a},__extends=this&&this.__extends||function(t,e){function a(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)},LoadingUI=function(t){function e(e){var a=t.call(this)||this;return a.from=e,a.addEventListener(egret.Event.ADDED_TO_STAGE,a.onAddToStage,a),a}return __extends(e,t),e.prototype.onAddToStage=function(t){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.x=.5*this.stage.stageWidth-240,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center",this.textField.size=40,"complete"===this.from?this.textField.textColor=0:this.textField.textColor=16777215},e.prototype.setProgress=function(t,e){var a=(t/e*100).toFixed(0);this.textField.text=a+"%"},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI"),egret.ImageLoader.crossOrigin="anonymous";var Main=function(t){function e(){var e=t.call(this)||this;return e.avatarTweenDuration=400,e.maskshpTweenDuration=300,e.isResourceLoadEnd=!1,e.isThemeLoadEnd=!1,e.defaultArmatureName="body_cloth",e.femaleDefaultCloth=[{part:"leg",slotName:"down_cloth",skeData:"down_cloth_ske_json",texData:"down_cloth_tex_json",texPng:"down_cloth_tex_png"},{part:"leg",slotName:"down_cloth_1",skeData:"down_cloth_1_ske_json",texData:"down_cloth_1_tex_json",texPng:"down_cloth_1_tex_png"},{part:"head",slotName:"head_cloth",skeData:"head_cloth_ske_json",texData:"head_cloth_tex_json",texPng:"head_cloth_tex_png"},{part:"head",slotName:"head_cloth_1",skeData:"head_cloth_1_ske_json",texData:"head_cloth_1_tex_json",texPng:"head_cloth_1_tex_png"},{part:"foot",slotName:"shoe_cloth",skeData:"shoe_cloth_ske_json",texData:"shoe_cloth_tex_json",texPng:"shoe_cloth_tex_png"},{part:"foot",slotName:"shoe_cloth_1",skeData:"shoe_cloth_1_ske_json",texData:"shoe_cloth_1_tex_json",texPng:"shoe_cloth_1_tex_png"},{part:"body",slotName:"up_cloth",skeData:"up_cloth_ske_json",texData:"up_cloth_tex_json",texPng:"up_cloth_tex_png"},{part:"body",slotName:"up_cloth_1",skeData:"up_cloth_1_ske_json",texData:"up_cloth_1_tex_json",texPng:"up_cloth_1_tex_png"},{part:"bonusDecorate",slotName:"decoration_cloth",skeData:"decoration_cloth_ske_json",texData:"decoration_cloth_tex_json",texPng:"decoration_cloth_tex_png"},{part:"pet",slotName:"pet_cloth",skeData:"pet_cloth_ske_json",texData:"pet_cloth_tex_json",texPng:"pet_cloth_tex_png"}],e.maleDefaultCloth=[{part:"leg",slotName:"down_cloth",skeData:"down_cloth_ske_json",texData:"down_cloth_tex_json",texPng:"down_cloth_tex_png"},{part:"leg",slotName:"down_cloth_1",skeData:"down_cloth_1_ske_json",texData:"down_cloth_1_tex_json",texPng:"down_cloth_1_tex_png"},{part:"head",slotName:"head_cloth",skeData:"head_cloth_ske_json",texData:"head_cloth_tex_json",texPng:"head_cloth_tex_png"},{part:"head",slotName:"head_cloth_1",skeData:"head_cloth_1_ske_json",texData:"head_cloth_1_tex_json",texPng:"head_cloth_1_tex_png"},{part:"foot",slotName:"shoe_cloth",skeData:"shoe_cloth_ske_json",texData:"shoe_cloth_tex_json",texPng:"shoe_cloth_tex_png"},{part:"foot",slotName:"shoe_cloth_1",skeData:"shoe_cloth_1_ske_json",texData:"shoe_cloth_1_tex_json",texPng:"shoe_cloth_1_tex_png"},{part:"body",slotName:"up_cloth",skeData:"up_cloth_ske_json",texData:"up_cloth_tex_json",texPng:"up_cloth_tex_png"},{part:"body",slotName:"up_cloth_1",skeData:"up_cloth_1_ske_json",texData:"up_cloth_1_tex_json",texPng:"up_cloth_1_tex_png"},{part:"bonusDecorate",slotName:"decoration_cloth",skeData:"decoration_cloth_ske_json",texData:"decoration_cloth_tex_json",texPng:"decoration_cloth_tex_png"},{part:"pet",slotName:"pet_cloth",skeData:"pet_cloth_ske_json",texData:"pet_cloth_tex_json",texPng:"pet_cloth_tex_png"}],e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e.gender=egret.getOption("gender"),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()};var e=egret.getOption("from");this.loadingView=new LoadingUI(e),this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup(this.gender)},e.prototype.onResourceLoadComplete=function(t){t.groupName==this.gender&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t),window.location.reload(!0)},e.prototype.onResourceProgress=function(t){t.groupName==this.gender&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){window.COSPLAY_STAGE=this;var t=egret.getOption("from"),e=RES.getRes(this.gender+"_default_ske_json"),a=RES.getRes(this.gender+"_default_tex_json"),o=RES.getRes(this.gender+"_default_tex_png");try{var s=new dragonBones.EgretFactory;s.addSkeletonData(dragonBones.DataParser.parseDragonBonesData(e)),s.addTextureAtlas(new dragonBones.EgretTextureAtlas(o,a)),this.armature=s.buildArmature(this.defaultArmatureName),this.armatureDisplay=this.armature.getDisplay()}catch(i){console.log(i)}this.armatureGroup=new egret.DisplayObjectContainer,this.armatureGroup.width=this.armatureDisplay.width,this.armatureGroup.height=this.armatureDisplay.height,"my"===t?(this.armatureGroup.scaleX=.7,this.armatureGroup.scaleY=.7):"rn"===t?(this.armatureGroup.scaleX=.62,this.armatureGroup.scaleY=.62):(this.armatureGroup.scaleX=.7,this.armatureGroup.scaleY=.7),this.armatureDisplay.x=.5*this.armatureGroup.width,this.armatureDisplay.y=.5*this.armatureGroup.height,this.armatureGroup.addChild(this.armatureDisplay),this.armatureGroup.x=.5*this.stage.stageWidth-this.armatureGroup.width*this.armatureGroup.scaleX/2;var r=0;"rn"===t?r=50:"my"===t&&(r=10),this.armatureGroup.y=.5*this.stage.$stageHeight-this.armatureGroup.height*this.armatureGroup.scaleY/2+r,this.bgShadowLayout=new egret.Shape,this.bgShadowLayout.graphics.beginFill(0),this.bgShadowLayout.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),this.bgShadowLayout.graphics.endFill(),this.bgShadowLayout.visible=!1;var n=RES.getRes("default_frame_backward_png");this.bgBitmap=new egret.Bitmap,this.bgBitmap.texture=n,this.bgBitmap.x=.5*this.stage.stageWidth-200,this.bgBitmap.y=.5*this.stage.stageHeight-200,this.bgBitmap.width=400,this.bgBitmap.height=400,this.bgBitmap.visible=!1,this.fgBitmap=new egret.Bitmap,this.fgBitmap.texture=null,this.fgBitmap.x=.5*this.stage.stageWidth-200,this.fgBitmap.y=.5*this.stage.stageHeight-200,this.fgBitmap.width=400,this.fgBitmap.height=400,this.fgBitmap.visible=!1,this.maskshp=new egret.Shape,this.maskshp.x=.5*this.stage.stageWidth,this.maskshp.y=.5*this.stage.stageHeight,this.maskshp.graphics.beginFill(0,1),this.maskshp.graphics.drawCircle(0,0,200),this.maskshp.graphics.endFill(),this.maskshp.visible=!1,this.addChild(this.bgShadowLayout),this.addChild(this.bgBitmap),this.addChild(this.armatureGroup),this.addChild(this.maskshp),this.addChild(this.fgBitmap),window.COSPLAY&&window.COSPLAY.$assetsOnLoaded&&window.COSPLAY.$assetsOnLoaded(),dragonBones.WorldClock.clock.add(this.armature)},e.prototype.getBoneBase64Img=function(){var t=new egret.RenderTexture;t.drawToTexture(this.armatureGroup);var e=t.toDataURL("image/png",new egret.Rectangle(this.armatureDisplay.x-.5*this.armatureDisplay.width,this.armatureDisplay.y-.5*this.armatureDisplay.height,this.armatureDisplay.width,this.armatureDisplay.height)),a=window.YCPostMessage||window.postMessage;a("[share]"+e)},e.prototype.cutAvatar=function(){this.bgShadowLayout.visible=!1;var t=new egret.RenderTexture;t.drawToTexture(this,new egret.Rectangle(.5*this.stage.stageWidth-206,.5*this.stage.stageHeight-206,412,412));var e=t.toDataURL("image/png");this.bgShadowLayout.visible=!0;var a=window.YCPostMessage||window.postMessage;a(e)},e.prototype.entryAvatar=function(t,e){var a=egret.getOption("from"),o=egret.Tween.get(this.armatureDisplay),s=egret.Tween.get(this.bgShadowLayout),i=220;("rn"===a||"my"===a)&&(i=120);var r=this.armatureDisplay.height+i,n=this.armatureDisplay.x;"male"===this.gender?n-=50:"female"===this.gender&&(n-=20),o.to({scaleX:2.3,scaleY:2.3,y:r,x:n},this.avatarTweenDuration,egret.Ease.quadInOut),this.bgShadowLayout.visible=!0,s.to({alpha:.7},this.maskshpTweenDuration),this.bgBitmap.visible=!0,this.fgBitmap.visible=!0,this.fgBitmap.visible=!0,this.armatureDisplay.mask=this.maskshp,this.setAvatarBackground(t,e)},e.prototype.exitAvatar=function(){var t=this,e=egret.Tween.get(this.armatureDisplay),a=egret.Tween.get(this.bgShadowLayout),o=this.armatureDisplay.x;"male"===this.gender?o+=50:"female"===this.gender&&(o+=20),e.to({scaleX:1,scaleY:1,y:.5*this.armatureGroup.height,x:o},this.avatarTweenDuration,egret.Ease.quadInOut),a.to({alpha:0},this.maskshpTweenDuration),setTimeout(function(){t.bgShadowLayout.visible=!1},this.maskshpTweenDuration),this.bgBitmap.visible=!1,this.fgBitmap.visible=!1,this.maskshp.visible=!1,this.armatureDisplay.mask=null},e.prototype.setSlotDisplay=function(t,e,a,o){var s=this.getResJsonPromise(e),i=this.getResJsonPromise(a),r=this.getResTexturePromise(o),n=function(e){var a=e[0],o=e[1],s=e[2],i=new dragonBones.EgretFactory;i.addSkeletonData(dragonBones.DataParser.parseDragonBonesData(a)),i.addTextureAtlas(new dragonBones.EgretTextureAtlas(s,o));var r=i.buildArmature(t),n=(r.getDisplay(),this.armature.getSlot(t));n.setDisplay(r)}.bind(this);Promise.all([s,i,r]).then(n)},e.prototype.setSlotDisplayByUrlGroup=function(t){var e,a,o,s,i=/^.+\/(.+(?:_\d)*)_([a-zA-Z]+)\.([a-zA-Z]+)$/,r=t.map(function(t){return i.exec(t)});r.forEach(function(t){var i=t[3],r=t[2];e||(e=t[1]),"png"===i&&"tex"===r?o=t[0]:"json"===i&&"tex"===r?a=t[0]:"json"===i&&"ske"===r&&(s=t[0])}),this.setSlotDisplay(e,s,a,o)},e.prototype.setSlotDisplayByResources=function(t){var e=this;t.forEach(function(t){e.setSlotDisplayByUrlGroup(t)})},e.prototype.setDefaultSlot=function(t){if(t){var e="female"===this.gender?this.femaleDefaultCloth:this.maleDefaultCloth,a=e.filter(function(e){return e.part===t});this.setDefaultDressByArray(a)}},e.prototype.takeOffAllDress=function(){var t="female"===this.gender?this.femaleDefaultCloth:this.maleDefaultCloth;this.setDefaultDressByArray(t)},e.prototype.setDefaultDressByArray=function(t){var e=this;t.forEach(function(t){var a=RES.getRes(e.gender+"_"+t.skeData),o=RES.getRes(e.gender+"_"+t.texData),s=RES.getRes(e.gender+"_"+t.texPng),i=new dragonBones.EgretFactory;i.addSkeletonData(dragonBones.DataParser.parseDragonBonesData(a)),i.addTextureAtlas(new dragonBones.EgretTextureAtlas(s,o));var r=i.buildArmature(t.slotName),n=(r.getDisplay(),e.armature.getSlot(t.slotName));n.setDisplay(r)})},e.prototype.getAllSlots=function(){var t=this.armature.getSlots();return t},e.prototype.playBoneAnimation=function(t){void 0===t&&(t="newAnimation"),t||(t="newAnimation");var e=this.getAllSlots();e.forEach(function(e){var a=e.childArmature;a.animation.gotoAndPlay(t)}),this.armature.animation.gotoAndPlay(t),egret.startTick(this.onTicker,this)},e.prototype.stopBoneAnimation=function(t){void 0===t&&(t="newAnimation");var e=this.getAllSlots();this.armature.animation.gotoAndStop(t),e.forEach(function(e){var a=e.childArmature;a.animation.stop(t)}),egret.stopTick(this.onTicker,this)},e.prototype.setAvatarBackground=function(t,e){var a=this;if(t&&e){var o=this.getResTexturePromise(t),s=this.getResTexturePromise(e);Promise.all([o,s]).then(function(t){var e=t[0],o=t[1];a.bgBitmap.texture=e,a.fgBitmap.texture=o})}else{var i=RES.getRes("default_frame_backward_png");this.bgBitmap.texture=i,this.fgBitmap.texture=null}},e.prototype.getResTexturePromise=function(t){return new Promise(function(e,a){RES.getResByUrl(t,function(t){e(t)},this,RES.ResourceItem.TYPE_IMAGE)})},e.prototype.getResJsonPromise=function(t){return new Promise(function(e,a){RES.getResByUrl(t,function(t){e(t)},this,RES.ResourceItem.TYPE_JSON)})},e.prototype.onTicker=function(t){this._time||(this._time=t);var e=t,a=e-this._time;return this._time=e,dragonBones.WorldClock.clock.advanceTime(a/1e3),!1},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");